<!doctype html>

<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="register.css">

    <link href="https://fonts.googleapis.com/css?family=Anaheim|Abel" rel="stylesheet">

    <!-- W3 school CSS Effects -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <title>User Register</title>

</head>

<body>

    <div id="ytWidget" align="right"></div><script src="https://translate.yandex.net/website-widget/v1/widget.js?widgetId=ytWidget&pageLang=en&widgetTheme=dark&autoMode=false" type="text/javascript"></script>

    <div class="container" align="center">

      <img class="icon" src="icon.png" align="center">

      <h1 class="heading w3-animate-opacity"><b>Charter</b></h1>

      <h2 class="heading2 w3-animate-opacity">User Registration Dashboard</h2>

      <br>

  </div>

  <div class="container-fluid explain">

     <div style="margin-left: 1rem; margin-right: 1rem;">

        <br>
        <br>

        <h1 class="heading3" style="color: white"><b> Read This <span class="text-muted">(Important)</span></b></h1>

        <br>

        <p class="textPara">

            <b> Download MetaMask Chrome Extension</b> - Every data upload to the Contract requires some Transaction Fees and this is paid using Ethereum Cryptocurrency, to simplify this process MetaMask Chrome Extension Wallet is used, read <a href="https://medium.com/@followcoin/how-to-install-metamask-88cbdabc1d28"><u>Here</u></a>

            <br>
            <br>

            <b>Get Ropsten TestCoins</b> - This application is deployed on Ropsten TestNet, users need to select Ropsten TestNet in their MetaMask wallets and get Test Coins (These are free) from <a href="https://faucet.ropsten.be/"><u>Here</u></a>

            <br>
            <br>

            Read the Product Manual <a href="ReadMore.pdf"><u>Here</u></a> for more info

            <br>
            <br>
            <br>
        </p>

    </div>

</div>

<div class="userForm" align="center">

    <br>
    <br>
    <br>

    <h1 class="heading3"><b>Registration Form</b></h1>
    <br>

    <img src="loader.gif" id="loader" class="loader">

    <br>
    <br>

    <div class="alert alert-dark message"><b>Transaction on EtherScan - <a href="" id="hashBlock"> Click Here</b></a></div>
    <br>
    <div class="alert alert-danger message" id="message1" style="font-weight: bold; display: none;"></div> 
    <br>
    <div class="alert alert-danger message">New Users need to Verify their Public Address by signing the Disclaimer (First, <a href="termsconditions.html" class="message"><b>Read Terms and Conditions </b></a>) and then Complete your Registration.<br> You will need <b>MetaMask Wallet</b> for these Steps</div>
    <br>
    

    <form style="margin-left: 1rem">

        <input class="formInput form-control" type="text" id="legalName" placeholder="Enter Legal Name" required>
        <br>
        <input class="formInput form-control" type="email" id="email" placeholder="Enter Email Address" required>
        <br>
        <input class="formInput form-control" type="number" id="aadhaar" placeholder="Enter Aadhaar (12 Digits)" min="100000000000" max="999999999999" required>

        <br>
        <button type="button" id="acceptButton" class="getStarted">Verify My Address</button>
        <br>
        <button type="button" id="registerButton" class="getStarted">Complete Registration</button>

    </form>

    <br>
    <br>
    <br>
    <br>

</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

<script>

    window.addEventListener('load', async () => {
            // Modern dapp browsers...
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                try {
                        // Request account access if needed
                        await ethereum.enable();
                        // Acccounts now exposed
                    web3.eth.sendTransaction({/* ... */});
                } catch (error) {
                    // User denied account access...
                }
            }
                // Legacy dapp browsers...
                else if (window.web3) {
                    window.web3 = new Web3(web3.currentProvider);
                // Acccounts always exposed
            web3.eth.sendTransaction({/* ... */});
        }
            // Non-dapp browsers...
            else {

                alert('Install MetaMask Chrome Extension, read below for Instructions !!');
            }
        });

        var rentContract = web3.eth.contract([
    {
        "constant": false,
        "inputs": [
            {
                "name": "_status",
                "type": "bool"
            }
        ],
        "name": "approveTenant",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_index",
                "type": "uint256"
            }
        ],
        "name": "confirmContract",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_name",
                "type": "string"
            },
            {
                "name": "_email",
                "type": "string"
            },
            {
                "name": "_aadhaar",
                "type": "uint256"
            },
            {
                "name": "_sign",
                "type": "string"
            }
        ],
        "name": "createNewUser",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_amount",
                "type": "uint256"
            }
        ],
        "name": "feePayment",
        "outputs": [],
        "payable": true,
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "governLogin",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_lat",
                "type": "string"
            },
            {
                "name": "_lon",
                "type": "string"
            },
            {
                "name": "_sqFt",
                "type": "uint256"
            },
            {
                "name": "_rooms",
                "type": "uint256"
            },
            {
                "name": "_extra",
                "type": "string"
            },
            {
                "name": "_ipfs",
                "type": "string"
            }
        ],
        "name": "newDetails",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_add",
                "type": "string"
            },
            {
                "name": "_type",
                "type": "string"
            },
            {
                "name": "_timeMonths",
                "type": "uint256"
            },
            {
                "name": "_rent",
                "type": "uint256"
            },
            {
                "name": "_security",
                "type": "uint256"
            }
        ],
        "name": "newHome",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_tenant",
                "type": "address"
            }
        ],
        "name": "registerParties",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "tenantLogin",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            }
        ],
        "name": "startMessage",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "status",
                "type": "uint256"
            }
        ],
        "name": "registerParty",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "status",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "FeePayable",
                "type": "uint256"
            }
        ],
        "name": "registerHome",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "status",
                "type": "uint256"
            }
        ],
        "name": "registerDetails",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            }
        ],
        "name": "feePay",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "index",
                "type": "int256"
            }
        ],
        "name": "tenantLogs",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            }
        ],
        "name": "tenantApproves",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "array",
                "type": "int256[]"
            },
            {
                "indexed": false,
                "name": "arraySize",
                "type": "uint256"
            }
        ],
        "name": "govLogin",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "message",
                "type": "string"
            }
        ],
        "name": "confirmGovern",
        "type": "event"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "allHouses",
        "outputs": [
            {
                "name": "addressHouse",
                "type": "string"
            },
            {
                "name": "type_of_property",
                "type": "string"
            },
            {
                "name": "duration",
                "type": "uint256"
            },
            {
                "name": "rentAmount",
                "type": "uint256"
            },
            {
                "name": "securityFee",
                "type": "uint256"
            },
            {
                "name": "governFee",
                "type": "uint256"
            },
            {
                "name": "completed",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "allOtherDetails",
        "outputs": [
            {
                "name": "time_of_deploy",
                "type": "uint256"
            },
            {
                "name": "latitude",
                "type": "string"
            },
            {
                "name": "longitude",
                "type": "string"
            },
            {
                "name": "ipfs_url",
                "type": "string"
            },
            {
                "name": "squareFootage",
                "type": "uint256"
            },
            {
                "name": "numberBedrooms",
                "type": "uint256"
            },
            {
                "name": "others",
                "type": "string"
            },
            {
                "name": "feePaid",
                "type": "bool"
            },
            {
                "name": "isValid",
                "type": "bool"
            },
            {
                "name": "completed",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "allParties",
        "outputs": [
            {
                "name": "tenantApprove",
                "type": "bool"
            },
            {
                "name": "govApprove",
                "type": "bool"
            },
            {
                "name": "landlord",
                "type": "address"
            },
            {
                "name": "tenant",
                "type": "address"
            },
            {
                "name": "government",
                "type": "address"
            },
            {
                "name": "completed",
                "type": "bool"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    }
]);

        var rentInfo = rentContract.at('0x98906834bf09d94ab356ef5af7ba7ae184a3257e');
        // contract address ---------------------------------------------------------------------

        web3.eth.defaultAccount = web3.eth.accounts[0];

        var event = rentInfo.startMessage({}, 'latest');

        event.watch(function(error, result) {

            if(!error)
            {

                $("#message1").show();
                $("#hashBlock").show();

            if(result.transactionHash != $("#hashBlock").html())
                $("#loader").hide(); /// hide loader once we get successful response

                $('#hashBlock').attr("href", "https://ropsten.etherscan.io/tx/" + result.transactionHash);
                $("#message1").html(result.args.message);
                /// load data once we get the data back from the event User()
                //we used toAscii as we are using bytes we need to convert hex to string format for display
            }

            else
            {
                $('#loader').hide();
                console.log(error);
            }

        });

        var ans = false;
        var message;

        $("#acceptButton").click(function() {

            $("#loader").show();

            var currentDate = new Date();
            
            web3.personal.sign(web3.toHex("Disclaimer - I have read the Terms and Conditions carefully, dated - " + currentDate), web3.eth.accounts[0], 
                function(error, result){

                if(error)
                {
                    $("#loader").hide();
                    alert('Failed !! Digital Message Signature cannot be performed..');
                }

                else
                {
                    message = result;
                    ans = true;
                    $("#loader").hide();
                }

           });
        });

        $("#registerButton").click(function() {

            $("#loader").show();
            console.log(message);

            if(ans != false)
            {
                rentInfo.createNewUser($("#legalName").val(), $("#email").val(), $("#aadhaar").val(), message, (err, res) => {
            
                if(err) {
                    $("#loader").hide();
                }

            });

            }

            else {

                alert('Complete Step 1 - Verify your Address, by signing the Disclaimer (Click Verify)');
            }

        });   

        

    </script>

    </body>

    </html>